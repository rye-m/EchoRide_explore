<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Audio Board</title>
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./styles.css" />
</head>

<body>
    <main>
        <wired-card elevation="5">
            <h1>Audio Board</h1>
            <!-- <p>Press buttons to play sounds!</p> -->
        </wired-card>

        <div class="main-sections">
            <div class="launchpad-section">
                <!-- 4x4 Button Grid -->
                <wired-card elevation="3">
                    <h2>Audio board</h2>
                    <div class="launchpad-grid" id="launchpadGrid">
                        <!-- Buttons will be generated by JavaScript -->
                    </div>
                </wired-card>
            </div>

            <div class="assign-section">
                <!-- Sound Assignment Section -->
                <wired-card elevation="3">
                    <h2>Assign Sounds</h2>
                    <div class="url-input-section" id="urlInputSection">
                        <!-- URL inputs will be generated by JavaScript -->
                    </div>
                    <div class="status" id="status"></div>
                </wired-card>
            </div>
        </div>

        <!-- Text-to-Speech Section -->
        <section class="tts-section">
            <wired-card elevation="3">
                <h2>Text-to-Speech</h2>
                <div class="tts-controls">
                    <wired-input id="ttsInput" placeholder="Type your message here..." rows="3" maxlength="500">
                    </wired-input>

                    <wired-button id="ttsButton" elevation="2">
                        â–¶ Play
                    </wired-button>

                    <div class="status" id="ttsStatus"></div>
                </div>

                <!-- TTS History Section -->
                <div class="tts-history">
                    <h3>Speech History</h3>
                    <div class="history-container" id="historyContainer">
                        <div class="empty-history" id="emptyHistory">No speech history yet...</div>
                        <div id="historyList"></div>
                    </div>
                    <div class="history-controls">
                        <wired-button id="clearHistoryButton" class="clear-history-btn" elevation="1">
                            Clear History
                        </wired-button>
                    </div>
                </div>
            </wired-card>
        </section>
    </main>
</body>

<script type="module" src="https://unpkg.com/wired-elements?module"></script>
<script type="module">
    class SoundLaunchpadApp {
        constructor() {
            this.sounds = {}; // Store sound URLs
            this.audioElements = {}; // Store audio objects
            this.playingAudios = {}; // Track currently playing sounds
            this.isSpeaking = false;
            this.currentUtterance = null;
            this.speechHistory = []; // Store TTS history
            this.maxHistoryItems = 10; // Limit history size

            this.init();
        }

        init() {
            // Wait for wired-elements to load
            setTimeout(() => {
                this.createLaunchpadButtons();
                this.createUrlInputs();
                this.setupEventListeners();
                this.loadSpeechHistory();
                this.showStatus('Ready! Assign sounds to buttons using URLs below.');
            }, 500);
        }

        createLaunchpadButtons() {
            const grid = document.getElementById('launchpadGrid');

            for (let i = 1; i <= 16; i++) {
                const button = document.createElement('wired-button');
                button.className = 'pad-button';
                button.id = `pad-${i}`;
                button.textContent = i;
                button.elevation = "2";
                button.addEventListener('click', () => this.playSound(i));

                grid.appendChild(button);
            }
        }

        createUrlInputs() {
            const section = document.getElementById('urlInputSection');

            for (let i = 1; i <= 16; i++) {
                const row = document.createElement('div');
                row.className = 'url-input-row';

                const label = document.createElement('span');
                label.className = 'url-label';
                label.textContent = `${i}:`;

                const input = document.createElement('wired-input');
                input.id = `url-${i}`;
                input.placeholder = `MP3 URL for button ${i}`;

                const setButton = document.createElement('wired-button');
                setButton.className = 'set-button';
                setButton.textContent = 'Set';
                setButton.addEventListener('click', () => this.assignSound(i));

                row.appendChild(label);
                row.appendChild(input);
                row.appendChild(setButton);
                section.appendChild(row);
            }
        }

        setupEventListeners() {
            // Text-to-Speech
            const ttsButton = document.getElementById('ttsButton');
            const ttsInput = document.getElementById('ttsInput');
            const clearHistoryButton = document.getElementById('clearHistoryButton');

            ttsButton.addEventListener('click', () => this.toggleSpeech());
            clearHistoryButton.addEventListener('click', () => this.clearHistory());

            // Ctrl+Enter shortcut for TTS
            ttsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    this.toggleSpeech();
                }
            });

            // Keyboard shortcuts for buttons (1-9, q-w-e-r, a-s-d-f, z-x-c-v)
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName.toLowerCase().includes('input') ||
                    e.target.tagName.toLowerCase().includes('textarea')) {
                    return; // Don't trigger when typing in inputs
                }

                const keyMap = {
                    '1': 1, '2': 2, '3': 3, '4': 4,
                    'q': 5, 'w': 6, 'e': 7, 'r': 8,
                    'a': 9, 's': 10, 'd': 11, 'f': 12,
                    'z': 13, 'x': 14, 'c': 15, 'v': 16
                };

                const buttonNumber = keyMap[e.key.toLowerCase()];
                if (buttonNumber) {
                    this.playSound(buttonNumber);
                }
            });
        }

        async assignSound(buttonNumber) {
            const urlInput = document.getElementById(`url-${buttonNumber}`);
            const url = this.getInputValue(urlInput).trim();

            if (!url) {
                this.showStatus('Please enter a URL');
                return;
            }

            try {
                const audio = new Audio();
                audio.preload = 'metadata';

                audio.oncanplaythrough = () => {
                    this.sounds[buttonNumber] = url;
                    this.audioElements[buttonNumber] = audio;
                    this.showStatus(`âœ… Sound assigned to button ${buttonNumber}`);

                    // Update button appearance
                    const button = document.getElementById(`pad-${buttonNumber}`);
                    button.classList.add('has-sound');
                };

                audio.onerror = () => {
                    this.showStatus('Error: Could not load audio from this URL');
                };

                audio.src = url;

            } catch (error) {
                this.showStatus('Error: Invalid URL or audio format');
            }
        }

        playSound(buttonNumber) {
            if (!this.sounds[buttonNumber]) {
                this.showStatus(`No sound assigned to button ${buttonNumber}`);
                return;
            }

            const button = document.getElementById(`pad-${buttonNumber}`);

            // If sound is already playing, stop it
            if (this.playingAudios[buttonNumber]) {
                this.playingAudios[buttonNumber].pause();
                this.playingAudios[buttonNumber].currentTime = 0;
                delete this.playingAudios[buttonNumber];
                button.classList.remove('playing');
                return;
            }

            // Create and play new audio
            const audio = new Audio(this.sounds[buttonNumber]);
            audio.volume = 0.7;

            // Track the playing audio
            this.playingAudios[buttonNumber] = audio;
            button.classList.add('playing');

            // Remove from playing list when finished
            audio.onended = () => {
                delete this.playingAudios[buttonNumber];
                button.classList.remove('playing');
            };

            audio.onerror = () => {
                delete this.playingAudios[buttonNumber];
                button.classList.remove('playing');
                this.showStatus('âŒ Error playing sound');
            };

            audio.play().catch(error => {
                delete this.playingAudios[buttonNumber];
                button.classList.remove('playing');
                this.showStatus('âŒ Error playing sound');
            });
        }

        toggleSpeech() {
            if (this.isSpeaking) {
                this.stopSpeech();
            } else {
                this.startSpeech();
            }
        }

        startSpeech() {
            const ttsInput = document.getElementById('ttsInput');
            const text = this.getInputValue(ttsInput).trim();

            if (!text) {
                this.showTTSStatus('Please enter some text to speak');
                return;
            }

            if (!('speechSynthesis' in window)) {
                this.showTTSStatus('Text-to-speech not supported in this browser');
                return;
            }

            // Create utterance
            this.currentUtterance = new SpeechSynthesisUtterance(text);

            // Set up event handlers
            this.currentUtterance.onstart = () => {
                this.isSpeaking = true;
                this.updateTTSButton();
                this.showTTSStatus('ðŸ”Š Speaking...');

                // Add to history when speech starts
                this.addToHistory(text);
            };

            this.currentUtterance.onend = () => {
                this.isSpeaking = false;
                this.currentUtterance = null;
                this.updateTTSButton();
                this.showTTSStatus('Finished speaking!');
                setTimeout(() => this.showTTSStatus(''), 2000);
            };

            this.currentUtterance.onerror = () => {
                this.isSpeaking = false;
                this.currentUtterance = null;
                this.updateTTSButton();
                this.showTTSStatus('Error occurred while speaking');
            };

            // Start speaking
            speechSynthesis.speak(this.currentUtterance);
        }

        stopSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            this.isSpeaking = false;
            this.currentUtterance = null;
            this.updateTTSButton();
            this.showTTSStatus('â¹ Speech stopped');
            setTimeout(() => this.showTTSStatus(''), 2000);
        }

        updateTTSButton() {
            const button = document.getElementById('ttsButton');
            if (this.isSpeaking) {
                button.textContent = 'â¹ Stop';
            } else {
                button.textContent = 'â–¶ Play';
            }
        }

        // Helper function to get value from wired-input/wired-textarea
        getInputValue(element) {
            if (element.value !== undefined) {
                return element.value;
            }

            // Try to find inner input/textarea element
            const innerInput = element.querySelector('input') ||
                element.querySelector('textarea');
            if (innerInput) {
                return innerInput.value || '';
            }

            return element.textContent || element.innerText || '';
        }

        showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            if (message) {
                setTimeout(() => status.textContent = '', 3000);
            }
        }

        showTTSStatus(message) {
            const status = document.getElementById('ttsStatus');
            status.textContent = message;
        }

        // TTS History Functions
        addToHistory(text) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();

            const historyItem = {
                text: text,
                time: timeString,
                timestamp: now.getTime()
            };

            // Add to beginning of array
            this.speechHistory.unshift(historyItem);

            // Keep only the last N items
            if (this.speechHistory.length > this.maxHistoryItems) {
                this.speechHistory = this.speechHistory.slice(0, this.maxHistoryItems);
            }

            this.updateHistoryDisplay();
            this.saveSpeechHistory();
        }

        updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');

            if (this.speechHistory.length === 0) {
                emptyHistory.style.display = 'block';
                historyList.innerHTML = '';
                return;
            }

            emptyHistory.style.display = 'none';

            const historyHTML = this.speechHistory.map((item, index) => `
          <div class="history-item" onclick="app.playFromHistory(${index})" title="Click to speak again">
            <div class="history-text">"${this.escapeHtml(item.text)}"</div>
            <div class="history-time">${item.time}</div>
          </div>
        `).join('');

            historyList.innerHTML = historyHTML;
        }

        playFromHistory(index) {
            if (index >= 0 && index < this.speechHistory.length) {
                const historyItem = this.speechHistory[index];

                // Set the text in the input field
                const ttsInput = document.getElementById('ttsInput');
                this.setInputValue(ttsInput, historyItem.text);

                // Speak the text
                if (!this.isSpeaking) {
                    this.startSpeech();
                }
            }
        }

        clearHistory() {
            this.speechHistory = [];
            this.updateHistoryDisplay();
            this.saveSpeechHistory();
            this.showTTSStatus('ðŸ—‘ï¸ History cleared');
            setTimeout(() => this.showTTSStatus(''), 2000);
        }

        // Helper function to set value in wired-input/wired-textarea
        setInputValue(element, value) {
            if (element.value !== undefined) {
                element.value = value;
                return;
            }

            // Try to find inner input/textarea element
            const innerInput = element.querySelector('input') ||
                element.querySelector('textarea');
            if (innerInput) {
                innerInput.value = value;
                return;
            }

            // Fallback - set text content
            element.textContent = value;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Save/Load history to/from localStorage (in-memory for Claude.ai)
        saveSpeechHistory() {
            // In a real environment, you would use:
            // localStorage.setItem('tts-history', JSON.stringify(this.speechHistory));
            // For Claude.ai, we just keep it in memory
        }

        loadSpeechHistory() {
            // In a real environment, you would use:
            // const saved = localStorage.getItem('tts-history');
            // if (saved) {
            //   this.speechHistory = JSON.parse(saved);
            //   this.updateHistoryDisplay();
            // }

            // For Claude.ai, start with empty history
            this.speechHistory = [];
            this.updateHistoryDisplay();
        }
    }

    // Initialize the app
    window.app = new SoundLaunchpadApp();
</script>

</html>